#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>

const unsigned char nullts[188]={
    0x47,0x1f,0xff,0x10,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
  };

 void main(int argc, char **argv) {
 	if (2 != argc) {
 		fprintf(stderr, "usage: %s ts_filename\n", argv[0]);
 		return ;
 	}
  	FILE *nts, *ts = fopen(argv[1], "rb");
  	if (!ts) {
 		fprintf(stderr, "cannot open ts file, %s...\n", argv[1]);
 		return ;
  	}
  	fseek(ts, 0L, SEEK_END);
 	int n, size = ftell(ts);
 	fseek(ts, 0L, SEEK_SET);
 	if (0 != (size % sizeof(nullts))) {
 		fprintf(stderr, "invalid ts file size %d...\n", size);
 		return ;
 	}
 	uint8_t *pn, *new = calloc(size/sizeof(int),sizeof(int));
 	if (!new) {
 		puts("failed to allocate internal file buffer, bail out...");
 		fclose(ts);
 		return ;
 	}
 	pn = new;
 	for (n=0; n<size/sizeof(nullts); n++) {
 		uint8_t pk[sizeof(nullts)] ;
 		size_t e = fread ( pk, sizeof(nullts), 1, ts );
 		if (1 != e) {
	 		puts("failed to read ts file, bail out...");
	 		fclose(ts);
	 		return ;
 		}
 		if(memcmp( nullts, (const void*)pk, sizeof(nullts))) {
 			memcpy(pn, pk, sizeof(nullts));
 			pn = pn + sizeof(nullts);
 		}
 	}
 	fclose(ts);
 	int nsize = (int)(pn - new);
 	nts  = fopen(argv[1], "wb");
  	if (!nts) {
 		fprintf(stderr, "cannot open ts file for write, %s...\n", argv[1]);
 		goto end ;
  	}
  	size_t e= fwrite ( new, nsize, 1, nts );
  	if (1 != e)
  		fprintf(stderr, "failed to remove null pkt from ts file, %s...\n", argv[1]);
end:
 	free(new);
  	fclose(nts);
 }